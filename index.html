<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Eléctrica Avanzada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .result-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .result-line:last-child {
            border-bottom: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 24px;
            height: 24px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Calculadora Eléctrica Avanzada</h1>
            <p class="text-md text-gray-600 mt-2">Basada en Normas IRAM y Reglamentación AEA 90364</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- CALCULADORA 1: SELECCIÓN DE CONDUCTOR -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-2 text-blue-700">1. Selección de Conductor</h2>
                <p class="text-sm text-gray-500 mb-6">Calcule la sección del cable por corriente admisible y caída de tensión.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Columna Izquierda -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2 border-b pb-1 text-gray-700">Datos de la Carga</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="potencia" class="block text-sm font-medium text-gray-700">Potencia (kW)</label>
                                <input type="number" id="potencia" value="5" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="tension" class="block text-sm font-medium text-gray-700">Tensión (V)</label>
                                <select id="tension" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="220">220 V (Monofásico)</option>
                                    <option value="380" selected>380 V (Trifásico)</option>
                                </select>
                            </div>
                            <div>
                                <label for="cosphi" class="block text-sm font-medium text-gray-700">Factor de Potencia (cos φ)</label>
                                <input type="number" id="cosphi" value="0.9" step="0.01" min="0" max="1" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    <!-- Columna Derecha -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2 border-b pb-1 text-gray-700">Datos de la Instalación</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="longitud" class="block text-sm font-medium text-gray-700">Longitud (metros)</label>
                                <input type="number" id="longitud" value="50" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                             <div>
                                <label for="tipoCable" class="block text-sm font-medium text-gray-700">Tipo de Cable</label>
                                <select id="tipoCable" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="IRAM 2178-XLPE-Cu" selected>IRAM 2178 (XLPE/Cobre)</option>
                                    <option value="IRAM 2178-PVC-Cu">IRAM 2178 (PVC/Cobre)</option>
                                    <option value="IRAM 247-PVC-Cu">IRAM 247-3 (PVC/Cobre)</option>
                                    <option value="IRAM 2178-XLPE-Al">IRAM 2178 (XLPE/Aluminio)</option>
                                    <option value="IRAM 2178-PVC-Al">IRAM 2178 (PVC/Aluminio)</option>
                                </select>
                            </div>
                            <div>
                                <label for="tipoTendido" class="block text-sm font-medium text-gray-700">Tipo de Tendido</label>
                                <select id="tipoTendido" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                     <option value="B1">B1/B2 (En cañería)</option>
                                     <option value="C" selected>C (En bandeja no perf.)</option>
                                     <option value="E">E/F (En bandeja perf.)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                     <div>
                        <h3 class="text-lg font-semibold mb-2 border-b pb-1 text-gray-700">Factores de Corrección</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="temperatura" class="block text-sm font-medium text-gray-700">Temp. Ambiente (°C)</label>
                                <input type="number" id="temperatura" value="40" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                             <div>
                                <label for="agrupamiento" class="block text-sm font-medium text-gray-700">Nº de Circuitos Agrupados</label>
                                <input type="number" id="agrupamiento" value="1" min="1" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    <div>
                         <h3 class="text-lg font-semibold mb-2 border-b pb-1 text-gray-700">Verificación Adicional</h3>
                        <div class="space-y-4">
                           <div>
                                <label for="caidaTensionAdm" class="block text-sm font-medium text-gray-700">Caída de Tensión Admisible (%)</label>
                                <select id="caidaTensionAdm" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="3">3% (Iluminación)</option>
                                    <option value="5" selected>5% (Fuerza Motriz)</option>
                                    <option value="15">15% (Arranque de Motores)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-4">
                    <button id="reset-calc1" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">Reiniciar</button>
                    <button id="calcular-cable" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">Calcular Sección</button>
                </div>
                
                <div id="resultado-cable" class="mt-6 hidden">
                     <h3 class="text-lg font-semibold mb-2 text-gray-800 border-t pt-4">Resultados de Selección</h3>
                     <div id="loader-cable" class="flex justify-center items-center p-4 hidden"><div class="loader"></div></div>
                     <div id="content-resultado-cable" class="bg-blue-50 p-4 rounded-lg">
                        <!-- Los resultados se inyectarán aquí -->
                     </div>
                </div>
            </div>

            <!-- CALCULADORA 2: VERIFICACIÓN POR CORTOCIRCUITO -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-2 text-green-700">2. Verificación por Cortocircuito</h2>
                <p class="text-sm text-gray-500 mb-6">Verifique si el cable soporta la corriente de cortocircuito (Icc) máxima.</p>

                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Columna Izquierda -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2 border-b pb-1 text-gray-700">Datos del Cable</h3>
                        <div class="space-y-4">
                             <div>
                                <label for="seccionVerificar" class="block text-sm font-medium text-gray-700">Sección a Verificar (mm²)</label>
                                <input type="text" id="seccionVerificar" placeholder="Se autocompleta desde Calc. 1" class="mt-1 block w-full bg-gray-200 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-gray-500" readonly>
                            </div>
                            <div>
                                <label for="aislacionVerificar" class="block text-sm font-medium text-gray-700">Aislación</label>
                                <input type="text" id="aislacionVerificar" placeholder="Se autocompleta" class="mt-1 block w-full bg-gray-200 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none" readonly>
                            </div>
                            <div>
                                <label for="materialVerificar" class="block text-sm font-medium text-gray-700">Material</label>
                                <input type="text" id="materialVerificar" placeholder="Se autocompleta" class="mt-1 block w-full bg-gray-200 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none" readonly>
                            </div>
                        </div>
                    </div>
                    <!-- Columna Derecha -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2 border-b pb-1 text-gray-700">Datos de la Falla</h3>
                        <div class="space-y-4">
                           
                            <div>
                                <label for="icc" class="flex items-center text-sm font-medium text-gray-700">
                                    <span>Corriente de Cortocircuito, Icc (kA)</span>
                                    <div class="tooltip ml-1">
                                        <span class="cursor-pointer text-blue-500">(?)</span>
                                        <span class="tooltiptext">Ingrese el valor de Icc trifásica máxima en el punto de instalación del cable. Este valor debe ser provisto por un estudio de cortocircuito o por la distribuidora.</span>
                                    </div>
                                </label>
                                <input type="number" id="icc" value="10" step="0.1" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                             <div>
                                <label for="tiempoActuacion" class="block text-sm font-medium text-gray-700">Tiempo de Actuación Protección (s)</label>
                                <input type="number" id="tiempoActuacion" value="0.1" step="0.01" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-4">
                    <button id="reset-calc2" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">Reiniciar</button>
                    <button id="verificar-icc" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">Verificar Icc</button>
                </div>

                <div id="resultado-icc" class="mt-6 hidden">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 border-t pt-4">Resultado de Verificación</h3>
                    <div id="content-resultado-icc" class="p-4 rounded-lg">
                       <!-- Los resultados de Icc se inyectarán aquí -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- BASE DE DATOS DE CABLES (Extraída de PDFs) ---
    const cableData = {
        'IRAM 2178-XLPE-Cu': {
            aislacion: 'XLPE', material: 'Cu', k_icc: 143,
            resistencias: [
                { s: 1.5, r: 16.96, x: 0.115 }, { s: 2.5, r: 10.18, x: 0.115 }, { s: 4, r: 6.31, x: 0.115 },
                { s: 6, r: 4.21, x: 0.107 }, { s: 10, r: 2.44, x: 0.107 }, { s: 16, r: 1.54, x: 0.100 },
                { s: 25, r: 0.995, x: 0.100 }, { s: 35, r: 0.707, x: 0.095 }, { s: 50, r: 0.493, x: 0.091 },
                { s: 70, r: 0.348, x: 0.086 }, { s: 95, r: 0.264, x: 0.083 }, { s: 120, r: 0.207, x: 0.081 },
                { s: 150, r: 0.167, x: 0.079 }, { s: 185, r: 0.138, x: 0.079 }, { s: 240, r: 0.106, x: 0.076 },
            ],
            corrientes: {
                B1: { // Tomamos B2 de tablas como B1
                    mono: [{s:1.5, i:20},{s:2.5, i:27},{s:4, i:36},{s:6, i:46},{s:10, i:63},{s:16, i:83},{s:25, i:108},{s:35, i:133},{s:50, i:159},{s:70, i:201},{s:95, i:241},{s:120, i:278},{s:150, i:304},{s:185, i:349},{s:240, i:418}],
                    tri:  [{s:1.5, i:18},{s:2.5, i:24},{s:4, i:32},{s:6, i:40},{s:10, i:55},{s:16, i:73},{s:25, i:96},{s:35, i:116},{s:50, i:140},{s:70, i:177},{s:95, i:212},{s:120, i:244},{s:150, i:273},{s:185, i:309},{s:240, i:362}],
                },
                C: {
                    mono: [{s:1.5, i:22},{s:2.5, i:30},{s:4, i:41},{s:6, i:53},{s:10, i:71},{s:16, i:97},{s:25, i:126},{s:35, i:156},{s:50, i:190},{s:70, i:245},{s:95, i:298},{s:120, i:348},{s:150, i:401},{s:185, i:460},{s:240, i:545}],
                    tri:  [{s:1.5, i:20},{s:2.5, i:27},{s:4, i:36},{s:6, i:47},{s:10, i:65},{s:16, i:87},{s:25, i:108},{s:35, i:134},{s:50, i:163},{s:70, i:208},{s:95, i:253},{s:120, i:293},{s:150, i:338},{s:185, i:386},{s:240, i:455}],
                },
                E: { // Tomamos E como E/F
                    mono: [{s:1.5, i:24},{s:2.5, i:33},{s:4, i:45},{s:6, i:57},{s:10, i:78},{s:16, i:105},{s:25, i:136},{s:35, i:168},{s:50, i:205},{s:70, i:263},{s:95, i:320},{s:120, i:373},{s:150, i:430},{s:185, i:493},{s:240, i:583}],
                    tri:  [{s:1.5, i:21},{s:2.5, i:29},{s:4, i:38},{s:6, i:49},{s:10, i:68},{s:16, i:91},{s:25, i:116},{s:35, i:144},{s:50, i:175},{s:70, i:224},{s:95, i:271},{s:120, i:315},{s:150, i:363},{s:185, i:415},{s:240, i:490}],
                }
            }
        },
        'IRAM 2178-PVC-Cu': {
            aislacion: 'PVC', material: 'Cu', k_icc: 115,
            resistencias: [
                { s: 1.5, r: 15.91, x: 0.115 }, { s: 2.5, r: 9.55, x: 0.115 }, { s: 4, r: 5.92, x: 0.115 },
                { s: 6, r: 3.95, x: 0.107 }, { s: 10, r: 2.29, x: 0.107 }, { s: 16, r: 1.48, x: 0.100 },
                { s: 25, r: 0.934, x: 0.100 }, { s: 35, r: 0.663, x: 0.095 }, { s: 50, r: 0.463, x: 0.091 },
                { s: 70, r: 0.326, x: 0.086 }, { s: 95, r: 0.248, x: 0.083 }, { s: 120, r: 0.195, x: 0.081 },
                { s: 150, r: 0.157, x: 0.079 }, { s: 185, r: 0.13, x: 0.079 }, { s: 240, r: 0.1, x: 0.076 },
            ],
            corrientes: {
                B1: {
                    mono: [{s:1.5, i:14},{s:2.5, i:20},{s:4, i:26},{s:6, i:33},{s:10, i:45},{s:16, i:60},{s:25, i:78},{s:35, i:97},{s:50, i:116},{s:70, i:146},{s:95, i:175},{s:120, i:202},{s:150, i:224},{s:185, i:256},{s:240, i:299}],
                    tri:  [{s:1.5, i:13},{s:2.5, i:17},{s:4, i:23},{s:6, i:30},{s:10, i:40},{s:16, i:54},{s:25, i:70},{s:35, i:86},{s:50, i:103},{s:70, i:130},{s:95, i:156},{s:120, i:179},{s:150, i:196},{s:185, i:222},{s:240, i:258}],
                },
                C: {
                    mono: [{s:1.5, i:17},{s:2.5, i:23},{s:4, i:31},{s:6, i:40},{s:10, i:55},{s:16, i:74},{s:25, i:97},{s:35, i:120},{s:50, i:146},{s:70, i:185},{s:95, i:224},{s:120, i:260},{s:150, i:299},{s:185, i:341},{s:240, i:401}],
                    tri:  [{s:1.5, i:15},{s:2.5, i:21},{s:4, i:28},{s:6, i:36},{s:10, i:50},{s:16, i:66},{s:25, i:84},{s:35, i:104},{s:50, i:125},{s:70, i:160},{s:95, i:194},{s:120, i:225},{s:150, i:260},{s:185, i:297},{s:240, i:351}],
                },
                E: {
                    mono: [{s:1.5, i:19},{s:2.5, i:26},{s:4, i:35},{s:6, i:44},{s:10, i:61},{s:16, i:82},{s:25, i:104},{s:35, i:129},{s:50, i:157},{s:70, i:202},{s:95, i:245},{s:120, i:285},{s:150, i:330},{s:185, i:378},{s:240, i:447}],
                    tri:  [{s:1.5, i:16},{s:2.5, i:22},{s:4, i:30},{s:6, i:37},{s:10, i:52},{s:16, i:70},{s:25, i:88},{s:35, i:110},{s:50, i:133},{s:70, i:171},{s:95, i:207},{s:120, i:240},{s:150, i:278},{s:185, i:317},{s:240, i:374}],
                }
            }
        },
        'IRAM 247-PVC-Cu': {
            aislacion: 'PVC', material: 'Cu', k_icc: 115,
            resistencias: [ // Usa las mismas que 2178 PVC/Cu
                { s: 1.5, r: 15.91, x: 0.115 }, { s: 2.5, r: 9.55, x: 0.115 }, { s: 4, r: 5.92, x: 0.115 },
                { s: 6, r: 3.95, x: 0.107 }, { s: 10, r: 2.29, x: 0.107 }, { s: 16, r: 1.48, x: 0.100 },
                { s: 25, r: 0.934, x: 0.100 }, { s: 35, r: 0.663, x: 0.095 }, { s: 50, r: 0.463, x: 0.091 },
            ],
            corrientes: {
                B1: { // Tendido B1 para IRAM 247-3
                    mono: [{s:1.5, i:15},{s:2.5, i:21},{s:4, i:28},{s:6, i:36},{s:10, i:50},{s:16, i:66},{s:25, i:88},{s:35, i:108},{s:50, i:131}],
                    tri:  [{s:1.5, i:14},{s:2.5, i:18},{s:4, i:25},{s:6, i:32},{s:10, i:44},{s:16, i:59},{s:25, i:77},{s:35, i:96},{s:50, i:117}],
                },
                C: null, E: null // No aplica para IRAM 247
            }
        },
        'IRAM 2178-XLPE-Al': {
            aislacion: 'XLPE', material: 'Al', k_icc: 94,
            resistencias: [
                { s: 16, r: 2.392, x: 0.100 }, { s: 25, r: 1.513, x: 0.100 },
                { s: 35, r: 1.093, x: 0.095 }, { s: 50, r: 0.800, x: 0.091 },
                { s: 70, r: 0.558, x: 0.086 }, { s: 95, r: 0.403, x: 0.083 },
                { s: 120, r: 0.321, x: 0.081 }, { s: 150, r: 0.262, x: 0.079 },
                { s: 185, r: 0.209, x: 0.079 }, { s: 240, r: 0.161, x: 0.076 },
            ],
            corrientes: {
                B1: {
                    mono: [{s:16, i:66},{s:25, i:86},{s:35, i:105},{s:50, i:126},{s:70, i:159},{s:95, i:191},{s:120, i:220},{s:150, i:238},{s:185, i:273},{s:240, i:326}],
                    tri:  [{s:16, i:58},{s:25, i:76},{s:35, i:94},{s:50, i:113},{s:70, i:142},{s:95, i:171},{s:120, i:197},{s:150, i:218},{s:185, i:248},{s:240, i:289}],
                },
                C: {
                    mono: [{s:16, i:76},{s:25, i:92},{s:35, i:115},{s:50, i:140},{s:70, i:180},{s:95, i:219},{s:120, i:255},{s:150, i:295},{s:185, i:338},{s:240, i:399}],
                    tri:  [{s:16, i:69},{s:25, i:82},{s:35, i:102},{s:50, i:124},{s:70, i:158},{s:95, i:192},{s:120, i:223},{s:150, i:258},{s:185, i:294},{s:240, i:348}],
                },
                E: {
                    mono: [{s:16, i:83},{s:25, i:98},{s:35, i:123},{s:50, i:149},{s:70, i:192},{s:95, i:234},{s:120, i:273},{s:150, i:315},{s:185, i:361},{s:240, i:428}],
                    tri:  [{s:16, i:70},{s:25, i:88},{s:35, i:109},{s:50, i:133},{s:70, i:170},{s:95, i:207},{s:120, i:239},{s:150, i:277},{s:185, i:316},{s:240, i:372}],
                }
            }
        },
         'IRAM 2178-PVC-Al': {
            aislacion: 'PVC', material: 'Al', k_icc: 76,
            resistencias: [ // Mismas que XLPE/Al
                { s: 16, r: 2.392, x: 0.100 }, { s: 25, r: 1.513, x: 0.100 },
                { s: 35, r: 1.093, x: 0.095 }, { s: 50, r: 0.800, x: 0.091 },
                { s: 70, r: 0.558, x: 0.086 }, { s: 95, r: 0.403, x: 0.083 },
                { s: 120, r: 0.321, x: 0.081 }, { s: 150, r: 0.262, x: 0.079 },
                { s: 185, r: 0.209, x: 0.079 }, { s: 240, r: 0.161, x: 0.076 },
            ],
            corrientes: {
                B1: {
                    mono: [{s:16, i:47},{s:25, i:62},{s:35, i:75},{s:50, i:90},{s:70, i:114},{s:95, i:137},{s:120, i:157},{s:150, i:175},{s:185, i:200},{s:240, i:234}],
                    tri:  [{s:16, i:42},{s:25, i:54},{s:35, i:67},{s:50, i:80},{s:70, i:101},{s:95, i:121},{s:120, i:139},{s:150, i:153},{s:185, i:173},{s:240, i:202}],
                },
                C: {
                    mono: [{s:16, i:57},{s:25, i:72},{s:35, i:90},{s:50, i:109},{s:70, i:139},{s:95, i:170},{s:120, i:197},{s:150, i:227},{s:185, i:259},{s:240, i:306}],
                    tri:  [{s:16, i:51},{s:25, i:64},{s:35, i:78},{s:50, i:96},{s:70, i:122},{s:95, i:148},{s:120, i:171},{s:150, i:197},{s:185, i:225},{s:240, i:265}],
                },
                E: {
                    mono: [{s:16, i:64},{s:25, i:77},{s:35, i:97},{s:50, i:117},{s:70, i:151},{s:95, i:183},{s:120, i:212},{s:150, i:245},{s:185, i:280},{s:240, i:331}],
                    tri:  [{s:16, i:53},{s:25, i:68},{s:35, i:84},{s:50, i:102},{s:70, i:131},{s:95, i:159},{s:120, i:184},{s:150, i:213},{s:185, i:244},{s:240, i:287}],
                }
            }
        }
    };
    
    const k1_temp = {
        PVC: [{t:10,f:1.4},{t:15,f:1.34},{t:20,f:1.29},{t:25,f:1.22},{t:30,f:1.15},{t:35,f:1.08},{t:40,f:1},{t:45,f:0.91},{t:50,f:0.82},{t:55,f:0.7},{t:60,f:0.57}],
        XLPE: [{t:10,f:1.26},{t:15,f:1.23},{t:20,f:1.19},{t:25,f:1.14},{t:30,f:1.1},{t:35,f:1.05},{t:40,f:1},{t:45,f:0.96},{t:50,f:0.9},{t:55,f:0.84},{t:60,f:0.78},{t:65,f:0.71},{t:70,f:0.64},{t:75,f:0.55},{t:80,f:0.45}]
    };

    const k2_agrup = [
        {n:1, f:1.00}, {n:2, f:0.80}, {n:3, f:0.70}, {n:4, f:0.65}, {n:5, f:0.60},
        {n:6, f:0.57}, {n:7, f:0.54}, {n:8, f:0.52}, {n:9, f:0.50}
    ];

    // --- LÓGICA DE LA CALCULADORA ---

    document.addEventListener('DOMContentLoaded', function() {
        const inputsCalc1 = ['potencia', 'tension', 'cosphi', 'longitud', 'tipoCable', 'tipoTendido', 'temperatura', 'agrupamiento', 'caidaTensionAdm'];
        inputsCalc1.forEach(id => document.getElementById(id).addEventListener('input', calculateAndDisplay));

        document.getElementById('calcular-cable').addEventListener('click', calculateAndDisplay);
        document.getElementById('reset-calc1').addEventListener('click', resetCalc1);
        
        document.getElementById('verificar-icc').addEventListener('click', verifyIcc);
        document.getElementById('reset-calc2').addEventListener('click', resetCalc2);

        // Actualizar opciones de tendido según cable
        document.getElementById('tipoCable').addEventListener('change', function() {
            const tipoTendidoSelect = document.getElementById('tipoTendido');
            if (this.value.includes('IRAM 247')) {
                tipoTendidoSelect.innerHTML = '<option value="B1">B1 (En cañería)</option>';
                tipoTendidoSelect.disabled = true;
            } else {
                 tipoTendidoSelect.innerHTML = `
                     <option value="B1">B1/B2 (En cañería)</option>
                     <option value="C" selected>C (En bandeja no perf.)</option>
                     <option value="E">E/F (En bandeja perf.)</option>
                 `;
                tipoTendidoSelect.disabled = false;
            }
        });
        
        document.getElementById('tension').addEventListener('change', function() {
            const caidaSelect = document.getElementById('caidaTensionAdm');
            if(this.value === '220'){ //Monofasico
                caidaSelect.value = "3";
            } else { //Trifasico
                caidaSelect.value = "5";
            }
        });

    });

    function calculateAndDisplay() {
        const resultDiv = document.getElementById('resultado-cable');
        const loader = document.getElementById('loader-cable');
        const content = document.getElementById('content-resultado-cable');
        
        resultDiv.style.display = 'block';
        content.style.display = 'none';
        loader.style.display = 'flex';

        // Simular un pequeño retardo para la UX
        setTimeout(() => {
            const result = selectCable();
            displayCableResult(result);
            loader.style.display = 'none';
            content.style.display = 'block';
        }, 500);
    }
    
    function getK1(aislacion, temp) {
        const factors = k1_temp[aislacion];
        if (!factors) return 1;
        let closest = factors.reduce((prev, curr) => (Math.abs(curr.t - temp) < Math.abs(prev.t - temp) ? curr : prev));
        return closest.f;
    }

    function getK2(numCircuitos) {
        if (numCircuitos > 9) return 0.50; // Valor para > 9
        const factor = k2_agrup.find(f => f.n === numCircuitos);
        return factor ? factor.f : 1;
    }

    function selectCable() {
        // 1. Obtener valores de entrada
        const P = parseFloat(document.getElementById('potencia').value) * 1000; // a W
        const U_str = document.getElementById('tension').value;
        const U = parseFloat(U_str);
        const cosphi = parseFloat(document.getElementById('cosphi').value);
        const L = parseFloat(document.getElementById('longitud').value) / 1000; // a km
        const tipoCircuito = U_str === '380' ? 'tri' : 'mono';
        const cableKey = document.getElementById('tipoCable').value;
        const tendidoKey = document.getElementById('tipoTendido').value;
        const temp = parseInt(document.getElementById('temperatura').value);
        const numCircuitos = parseInt(document.getElementById('agrupamiento').value);
        const deltaU_adm_perc = parseFloat(document.getElementById('caidaTensionAdm').value);
        
        const data = cableData[cableKey];
        if (!data || !data.corrientes[tendidoKey]) {
            return { error: `No hay datos disponibles para la combinación de cable (${cableKey}) y tendido (${tendidoKey}).` };
        }
        
        // 2. Calcular corriente de carga
        const I_carga = tipoCircuito === 'tri' ? (P / (Math.sqrt(3) * U * cosphi)) : (P / (U * cosphi));

        // 3. Obtener factores de corrección
        const k1 = getK1(data.aislacion, temp);
        const k2 = getK2(numCircuitos);
        const k_total = k1 * k2;

        // 4. Iterar y seleccionar sección
        const seccionesDisponibles = data.corrientes[tendidoKey][tipoCircuito];

        for (const seccion of seccionesDisponibles) {
            const I_tabla = seccion.i;
            const I_adm = I_tabla * k_total;

            if (I_adm >= I_carga) {
                // Candidato encontrado, ahora verificar caída de tensión
                const params = data.resistencias.find(r => r.s === seccion.s);
                if (!params) continue; // No hay datos de r,x para esta sección
                
                const r = params.r;
                const x = params.x;
                const sinphi = Math.sqrt(1 - Math.pow(cosphi, 2));
                const k_voltDrop = tipoCircuito === 'tri' ? Math.sqrt(3) : 2;

                const deltaU = k_voltDrop * L * I_carga * (r * cosphi + x * sinphi);
                const deltaU_perc = (deltaU / U) * 100;
                
                if (deltaU_perc <= deltaU_adm_perc) {
                    // ¡Éxito! Esta es la sección
                    return {
                        i_carga: I_carga,
                        seccion: seccion.s,
                        i_adm: I_adm,
                        k1, k2,
                        deltaU: deltaU,
                        deltaU_perc: deltaU_perc,
                        deltaU_adm_perc: deltaU_adm_perc,
                        datos_cable: data,
                        error: null
                    };
                }
            }
        }

        return { error: 'No se encontró una sección de cable que cumpla ambos criterios (Corriente Admisible y Caída de Tensión). Considere aumentar la sección manualmente o revisar los parámetros.' };
    }
    
    function displayCableResult(result) {
        const contentDiv = document.getElementById('content-resultado-cable');

        if (result.error) {
            contentDiv.innerHTML = `<div class="text-red-600 bg-red-100 p-4 rounded-lg text-center font-semibold">${result.error}</div>`;
            return;
        }

        // Actualizar campos para Calc 2
        document.getElementById('seccionVerificar').value = result.seccion + ' mm²';
        document.getElementById('aislacionVerificar').value = result.datos_cable.aislacion;
        document.getElementById('materialVerificar').value = result.datos_cable.material;

        contentDiv.innerHTML = `
            <div class="result-line">
                <span class="font-medium text-gray-600">Corriente de Carga (I<sub class="text-xs">carga</sub>)</span>
                <span class="font-bold text-lg text-blue-800">${result.i_carga.toFixed(2)} A</span>
            </div>
            <div class="p-4 bg-blue-100 my-2 rounded-lg">
                <div class="result-line border-blue-200">
                    <span class="font-bold text-blue-900">Sección Recomendada</span>
                    <span class="font-bold text-2xl text-blue-900">${result.seccion} mm²</span>
                </div>
                <div class="result-line border-blue-200">
                    <span class="font-medium text-gray-600">Corriente Admisible (I<sub class="text-xs">adm</sub>)</span>
                    <span class="font-bold text-lg text-blue-800">${result.i_adm.toFixed(2)} A</span>
                </div>
                 <div class="text-xs text-gray-500 text-center mt-2">
                    Factores aplicados: k1 (temp) = ${result.k1.toFixed(2)}, k2 (agrup) = ${result.k2.toFixed(2)}
                 </div>
            </div>
            <div class="p-4 bg-gray-100 my-2 rounded-lg">
                 <div class="result-line border-gray-200">
                    <span class="font-medium text-gray-600">Caída de Tensión (ΔU)</span>
                    <span class="font-bold text-lg ${result.deltaU_perc > result.deltaU_adm_perc ? 'text-red-600' : 'text-green-700'}">${result.deltaU_perc.toFixed(2)}% (${result.deltaU.toFixed(2)} V)</span>
                </div>
                 <div class="result-line border-gray-200">
                    <span class="font-medium text-gray-600">ΔU Admisible</span>
                    <span class="font-bold text-lg text-gray-800">${result.deltaU_adm_perc.toFixed(2)}%</span>
                </div>
            </div>
        `;
    }
    
    function verifyIcc() {
        const seccionStr = document.getElementById('seccionVerificar').value;
        if (!seccionStr) {
            alert("Primero debe calcular una sección en la Calculadora 1.");
            return;
        }

        const S = parseFloat(seccionStr);
        const cableKey = document.getElementById('tipoCable').value;
        const data = cableData[cableKey];
        const t = parseFloat(document.getElementById('tiempoActuacion').value);
        const icc_user_kA = parseFloat(document.getElementById('icc').value);

        if (!data || !t || !icc_user_kA) {
            alert("Por favor, complete todos los campos requeridos para la verificación.");
            return;
        }

        const k = data.k_icc;
        const I_adm_cc_A = (k * S) / Math.sqrt(t);
        const I_adm_cc_kA = I_adm_cc_A / 1000;
        
        const passes = I_adm_cc_kA >= icc_user_kA;

        const resultDiv = document.getElementById('resultado-icc');
        const contentDiv = document.getElementById('content-resultado-icc');
        resultDiv.style.display = 'block';

        contentDiv.innerHTML = `
            <div class="result-line">
                <span class="font-medium text-gray-600">Icc Admisible por el Cable (I<sub class="text-xs">adm cc</sub>)</span>
                <span class="font-bold text-lg text-gray-800">${I_adm_cc_kA.toFixed(2)} kA</span>
            </div>
            <div class="result-line">
                <span class="font-medium text-gray-600">Icc a soportar (dato)</span>
                <span class="font-bold text-lg text-gray-800">${icc_user_kA.toFixed(2)} kA</span>
            </div>
            <div class="mt-4 p-4 rounded-lg text-center font-bold text-xl ${passes ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${passes ? 'VERIFICA' : 'NO VERIFICA'}
            </div>
            <div class="text-xs text-center mt-2 text-gray-500">
                 ${passes ? 'La sección seleccionada es adecuada para la corriente de cortocircuito especificada.' : 'La sección es INSUFICIENTE. Debe aumentarla y volver a verificar.'}
            </div>
        `;
    }
    
    function resetCalc1() {
        document.getElementById('potencia').value = '5';
        document.getElementById('tension').value = '380';
        document.getElementById('cosphi').value = '0.9';
        document.getElementById('longitud').value = '50';
        document.getElementById('tipoCable').value = 'IRAM 2178-XLPE-Cu';
        document.getElementById('tipoTendido').value = 'C';
        document.getElementById('temperatura').value = '40';
        document.getElementById('agrupamiento').value = '1';
        document.getElementById('caidaTensionAdm').value = '5';
        document.getElementById('resultado-cable').style.display = 'none';
        document.getElementById('content-resultado-cable').innerHTML = '';
        resetCalc2();
    }
    
    function resetCalc2() {
        document.getElementById('seccionVerificar').value = '';
        document.getElementById('aislacionVerificar').value = '';
        document.getElementById('materialVerificar').value = '';
        document.getElementById('icc').value = '10';
        document.getElementById('tiempoActuacion').value = '0.1';
        document.getElementById('resultado-icc').style.display = 'none';
        document.getElementById('content-resultado-icc').innerHTML = '';
    }

    </script>

</body>
</html>
